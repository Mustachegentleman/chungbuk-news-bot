# 역설계서: 충북 교통 뉴스 텔레그램 봇

## 1. 시스템 개요

| 항목 | 내용 |
|------|------|
| 파일명 | `Chungbuk_Traffic_Bot.py` |
| 언어 | Python 3.9 |
| 목적 | 충청북도 지역 교통 관련 뉴스를 자동 수집하여 텔레그램으로 전송 |
| 실행 환경 | GitHub Actions (스케줄 기반, 매일 KST 08:30) 또는 로컬 실행 |
| 외부 의존성 | `requests`, `difflib` (표준 라이브러리), `email.utils` (표준 라이브러리) |

---

## 2. 아키텍처

```
┌─────────────────┐     ┌──────────────────────────────────┐     ┌─────────────────┐
│  네이버 검색 API  │────▶│         Python 봇 (정제)           │────▶│  텔레그램 Bot API │
│  (뉴스 데이터)    │     │  필터링 → 점수 산정 → 중복제거       │     │  (메시지 전송)    │
└─────────────────┘     └──────────────────────────────────┘     └─────────────────┘
        ▲                              │
        │                             ▼
   5개 검색 쿼리               최대 10건 뉴스 브리핑
```

---

## 3. 환경 변수 (설정값)

| 변수명 | 환경변수 키 | 용도 |
|--------|------------|------|
| `NAVER_CLIENT_ID` | `NAVER_ID` | 네이버 오픈 API 클라이언트 ID |
| `NAVER_CLIENT_SECRET` | `NAVER_SECRET` | 네이버 오픈 API 클라이언트 시크릿 |
| `TELEGRAM_TOKEN` | `TELEGRAM_TOKEN` | 텔레그램 봇 토큰 |
| `CHAT_ID` | `CHAT_ID` | 메시지를 수신할 텔레그램 채팅방 ID |

> GitHub Actions 사용 시 Repository Secrets에 등록하여 관리한다.

---

## 4. 함수별 상세 설계

### 4.1 `get_similarity(str1, str2)` — 문자 배열 유사도 계산

**목적:** 두 기사 제목 간 중복 여부를 판별하기 위한 문자열 유사도 측정

**알고리즘:**
1. 두 문장에서 공백(` `), 쉼표(`,`), 작은따옴표(`'`), 큰따옴표(`"`)를 제거
2. `difflib.SequenceMatcher`를 사용하여 문자 배열 기준 유사도 산출 (`.ratio()`)

**반환값:** `float` (0.0 ~ 1.0)

**특징:** 단어 집합 비교(자카드)가 아닌 **문자 순서 기반 비교**로, 어순이 비슷한 중복 기사를 더 정확히 탐지

---

### 4.2 `is_recent_news(pub_date_str)` — 최신 기사 여부 확인

**목적:** 기사 발행일이 현재 시각으로부터 24시간 이내인지 확인하여 오래된 기사를 제외

**처리 흐름:**
1. `email.utils.parsedate_to_datetime()`으로 RFC 2822 형식의 날짜 문자열 파싱
2. 현재 시각과의 차이(`timedelta`)를 계산
3. 차이가 1일 미만이면 `True`, 아니면 `False` 반환
4. 파싱 실패 시 예외를 포착하고 `False` 반환

**반환값:** `bool`

---

### 4.3 `get_news_score(item)` — 기사 신뢰도 점수 산정

**목적:** 언론사 원문 링크(`originallink`)와 네이버 링크(`link`)를 분석하여 기사의 신뢰도 점수를 계산

**채점 기준:**

| 항목 | 조건 | 점수 |
|------|------|------|
| 네이버 뉴스 플랫폼 | `link`에 `n.news.naver.com` 포함 | +10점 |
| 메이저 언론사 | `originallink`에 주요 도메인 포함 | +5점 |
| 충북 지역 유력지 | `originallink`에 지역 도메인 포함 | +5점 |
| 제목 길이 | `len(title) × 0.1` | 가변 |

**메이저 언론사 도메인 목록:**

```
yna.co.kr, newsis.com, news1.kr, nocutnews.co.kr,
kbs.co.kr, mbc.com, sbs.co.kr, ytn.co.kr
```

**충북 지역 도메인 목록:**

```
inews365, ccdailynews, jbnews, cctoday, chungbuk
```

**반환값:** `float` (점수가 높을수록 신뢰도 높음)

---

### 4.4 `is_valid_news(title)` — 뉴스 유효성 필터링

**목적:** 교통과 무관한 기사(범죄, 잡담 등)를 제거하고 교통 뉴스만 선별

**처리 흐름:**

```
입력(기사 제목)
    │
    ▼
[1단계] 블랙리스트 검사 ──── 포함 시 ──▶ False (차단)
    │
    │ 미포함
    ▼
[2단계] 화이트리스트 검사 ── 포함 시 ──▶ True (통과)
    │
    │ 미포함
    ▼
  False (차단)
```

**블랙리스트 (26개 금칙어):**

| 범주 | 키워드 |
|------|--------|
| 범죄 | 검거, 구속, 살인, 폭행, 사기, 마약, 성범죄, 횡령, 절도, 압수수색, 습격 |
| 사법 | 재판, 법원, 검찰, 경찰관 |
| 재해 | 화재, 불 |
| 채용/기타 | 공채, 채용 |
| 잡문 | 직업군인이야기, 칼럼, 인사, 부고, 운세, 게시판, 동정 |

**화이트리스트 (15개 교통 키워드):**

```
도로, 교통, 사고, 통제, 공사, 정체, 단속, 개통, 우회, 차량, 신호, 운전, 면허, 하이패스, 터널
```

**판정 로직:** 블랙리스트 우선 적용 → 화이트리스트 매칭 순서로 동작

---

### 4.5 `fetch_traffic_news()` — 뉴스 수집 및 정제

**목적:** 네이버 뉴스 검색 API를 호출하여 충북 교통 뉴스를 수집·정제·점수 정렬·중복 제거

**검색 쿼리 목록 (5개):**

| # | 검색어 |
|---|--------|
| 1 | 충북 교통 사고 |
| 2 | 청주 도로 통제 |
| 3 | 충북 도로공사 |
| 4 | 충북 실시간 교통 |
| 5 | 충북 교통 정체 |

**API 호출 상세:**

| 항목 | 값 |
|------|-----|
| 엔드포인트 | `https://openapi.naver.com/v1/search/news.json` |
| HTTP 메서드 | GET |
| 정렬 기준 | `sim` (유사도순) |
| 요청 건수 | 쿼리당 20건 (`display=20`) |
| 최대 수집량 | 5쿼리 × 20건 = 100건 (이론상 최대) |
| 인증 헤더 | `X-Naver-Client-Id`, `X-Naver-Client-Secret` |

**처리 파이프라인:**

```
[API 응답 수신]
    │
    ▼
[HTML 태그 제거]   <b>, </b>, &quot;, &apos; 치환
    │
    ▼
[is_recent_news]  발행 24시간 이내 기사만 통과
    │
    ▼
[is_valid_news]   블랙리스트/화이트리스트 필터링
    │
    ▼
[get_news_score]  각 기사에 신뢰도 점수 부여
    │
    ▼
[점수 기준 내림차순 정렬]  고신뢰도 기사가 우선순위 확보
    │
    ▼
[중복 제거]       SequenceMatcher 유사도 > 0.45이면 하위 기사 제거
    │
    ▼
[반환]  list[dict] — [{"title": str, "link": str, "score": float}, ...]
```

**HTML 엔티티 치환 규칙:**

| 원본 | 치환 |
|------|------|
| `<b>` | (제거) |
| `</b>` | (제거) |
| `&quot;` | `"` |
| `&apos;` | `'` |

**중복 제거 알고리즘:**
- 점수 내림차순으로 정렬된 기사를 순차 탐색
- 이미 선별된 기사와 `get_similarity()` 값을 비교
- 유사도 > 0.45 (45%)이면 동일 기사로 간주하여 하위 점수 기사를 제외
- **고신뢰도 기사가 중복 판정 시 항상 살아남는 구조**
- 시간 복잡도: O(n²) (n = 수집된 기사 수)

---

### 4.6 `send_telegram(news_list)` — 텔레그램 메시지 전송

**목적:** 정제된 뉴스 리스트를 텔레그램 메시지로 포맷팅하여 전송

**API 호출 상세:**

| 항목 | 값 |
|------|-----|
| 엔드포인트 | `https://api.telegram.org/bot{TOKEN}/sendMessage` |
| HTTP 메서드 | POST |
| 파라미터 | `chat_id`, `text`, `disable_web_page_preview=True` |

**메시지 포맷:**

뉴스가 있는 경우:
```
🚗 [2026년 02월 21일 충북 교통 뉴스 브리핑]

1. 기사 제목
🔗 기사 링크

2. 기사 제목
🔗 기사 링크

...

💡 24시간 이내 최신 뉴스 중 신뢰도가 높은 기사를 엄선했습니다.
```

뉴스가 없는 경우:
```
📢 2026년 02월 21일
오늘 충북 지역의 신규 교통 뉴스가 없습니다.
```

**제약 사항:**
- 최대 전송 기사 수: **10건** (`news_list[:10]`)
- 링크 미리보기: **비활성화** (`disable_web_page_preview: True`)

---

## 5. 메인 실행 흐름

```
__main__
    │
    ├─ fetch_traffic_news()     ← 뉴스 수집 + 필터링 + 점수 정렬 + 중복 제거
    │       │
    │       ▼
    ├─ send_telegram(news_data) ← 텔레그램 전송
    │       │
    │       ▼
    ├─ 콘솔 출력: "[시각] 전송 성공: N건"
    │
    └─ 예외 발생 시: "오류 발생: {에러 메시지}" 출력
```

---

## 6. 데이터 흐름도 (전체)

```
                        ┌─────────────────────────────────────────────────────────┐
                        │                  fetch_traffic_news()                    │
                        │                                                         │
  ┌────────────┐        │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌────────┐  │   ┌──────────┐
  │ 네이버 API  │───────▶│  │ HTML정제  │─▶│최신성필터 │─▶│유효성필터 │─▶│점수정렬│──│──▶│텔레그램  │
  │ (5쿼리×20건)│        │  │          │  │24시간이내 │  │블/화이트  │  │중복제거│  │   │sendMsg   │
  └────────────┘        │  └──────────┘  └──────────┘  └──────────┘  └────────┘  │   └──────────┘
                        │                                                         │
                        │  최대 100건 ──▶ 최신 기사만 ──▶ 교통뉴스만 ──▶ 고유기사만  │
                        └─────────────────────────────────────────────────────────┘
```

---

## 7. 기술적 특성 및 제약 사항

| 항목 | 상세 |
|------|------|
| 에러 처리 | 메인 함수에 try-except 1단계만 적용. API 개별 호출 실패 시 해당 쿼리 건너뜀 (status_code 200 검사) |
| 재시도 로직 | 없음 (API 호출 실패 시 해당 쿼리 결과 누락) |
| 로깅 | `print` 기반 콘솔 출력만 사용 |
| 데이터 저장 | 없음 (메모리 내 처리 후 즉시 전송, 상태 비저장) |
| 실행 방식 | 1회 실행 후 종료 (데몬/스케줄러 아님) |
| 스케줄링 | GitHub Actions cron 등 외부 스케줄러에 의존 |
| 중복 판정 기준 | SequenceMatcher 유사도 0.45 (45%) 초과 시 중복으로 간주 |
| 텔레그램 메시지 제한 | 텔레그램 메시지 최대 길이(4096자) 초과 시 별도 처리 없음 |

---

## 8. 외부 API 의존성 정리

### 8.1 네이버 검색 API

- **문서:** https://developers.naver.com/docs/serviceapi/search/news/news.md
- **인증:** 클라이언트 ID + Secret (헤더 방식)
- **일일 호출 한도:** 25,000건/일 (기본)
- **본 봇 1회 실행당 호출 수:** 5회

### 8.2 텔레그램 Bot API

- **문서:** https://core.telegram.org/bots/api#sendmessage
- **인증:** Bot Token (URL 경로 포함)
- **본 봇 1회 실행당 호출 수:** 1회

---

## 9. 배포 환경 (GitHub Actions)

```yaml
# .github/workflows/daily_run.yml
name: Daily Chungbuk Traffic News

on:
  schedule:
    # KST 오전 08:30 = UTC 전날 23:30
    - cron: '30 23 * * *'
  workflow_dispatch:  # 수동 실행 버튼

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: pip install requests

      - name: Run news bot
        env:
          NAVER_ID: ${{ secrets.NAVER_ID }}
          NAVER_SECRET: ${{ secrets.NAVER_SECRET }}
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: python Chungbuk_Traffic_Bot.py
```

| 항목 | 값 |
|------|-----|
| 실행 시각 | 매일 KST 08:30 (UTC 23:30) |
| Python 버전 | 3.9 |
| 실행 환경 | ubuntu-latest |
| 수동 실행 | `workflow_dispatch` 지원 |
